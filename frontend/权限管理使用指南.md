# 前端权限管理系统使用指南

## 概述

本项目的前端权限管理系统已经恢复并优化，提供了全面的身份验证和权限控制功能。

## 主要功能

### 1. 身份验证
- ✅ 用户登录/注册
- ✅ Session/Cookie 认证
- ✅ 自动登录状态检查
- ✅ 登录状态持久化

### 2. 权限控制
- ✅ 路由级权限控制
- ✅ 组件级权限控制
- ✅ 操作级权限控制
- ✅ 角色基础权限管理

### 3. 用户角色
- `super_admin` - 超级管理员
- `campus_admin` - 校区管理员
- `student` - 学员
- `coach` - 教练

## 使用方法

### 1. 在组件中使用权限检查

```vue
<template>
  <!-- 使用权限指令 -->
  <el-button v-permission="'manage_students'">管理学员</el-button>
  
  <!-- 使用权限组件 -->
  <PermissionGuard type="role" permission="super_admin">
    <el-button type="danger">删除校区</el-button>
  </PermissionGuard>
  
  <!-- 使用组合函数 -->
  <el-button v-if="canManageStudents" @click="handleManage">
    管理学员
  </el-button>
</template>

<script setup>
import { usePermissions } from '@/composables/usePermissions'
import PermissionGuard from '@/components/PermissionGuard.vue'

const { canPerformAction, isSuperAdmin } = usePermissions()

const canManageStudents = computed(() => 
  canPerformAction('manage_students')
)
</script>
```

### 2. 在路由中使用权限

```javascript
// 路由配置自动包含权限检查
{
  path: '/admin/campus',
  component: CampusManagement,
  meta: {
    requiresAuth: true,
    roles: ['super_admin'],
    title: '校区管理'
  }
}
```

### 3. 编程式权限检查

```javascript
import { requireAuth, requireRole } from '@/utils/auth'
import { usePermissions } from '@/composables/usePermissions'

// 检查登录状态
if (!requireAuth()) {
  // 用户未登录，已自动跳转到登录页
  return
}

// 检查角色权限
if (!requireRole(['super_admin', 'campus_admin'])) {
  // 用户权限不足，已自动处理
  return
}

// 使用组合函数
const { canAccessPage, canPerformAction } = usePermissions()

if (canAccessPage('/admin/campus')) {
  // 可以访问校区管理页面
}

if (canPerformAction('export_data')) {
  // 可以导出数据
}
```

### 4. API 请求权限

```javascript
// API 拦截器自动处理认证
import api from '@/utils/api'

// 所有 API 请求自动携带认证信息
const response = await api.get('/user/profile')

// 401 错误自动处理，会清除认证状态并跳转登录
// 403 错误会显示权限不足提示
```

## 权限配置

### 页面权限配置 (`utils/permissions.js`)

```javascript
export const PAGE_PERMISSIONS = {
  '/admin/campus': ['super_admin'],
  '/campus/students': ['campus_admin'],
  '/student/coaches': ['student'],
  '/coach/appointments': ['coach'],
  // ...
}
```

### 操作权限配置

```javascript
export function hasActionPermission(action, userRole, context = {}) {
  switch (action) {
    case 'manage_students':
      return ['campus_admin', 'super_admin'].includes(userRole)
    case 'approve_appointments':
      return userRole === 'coach'
    // ...
  }
}
```

## 组件

### PermissionGuard 组件

条件渲染组件，根据权限显示或隐藏内容：

```vue
<!-- 角色检查 -->
<PermissionGuard type="role" permission="super_admin">
  <AdminPanel />
</PermissionGuard>

<!-- 操作权限检查 -->
<PermissionGuard type="action" permission="manage_students">
  <StudentManagement />
</PermissionGuard>

<!-- 页面权限检查 -->
<PermissionGuard type="page" permission="/admin/campus">
  <CampusLink />
</PermissionGuard>

<!-- 多权限检查（任意一个） -->
<PermissionGuard 
  type="role" 
  :permission="['super_admin', 'campus_admin']"
  mode="any"
>
  <ManagementPanel />
</PermissionGuard>
```

### 权限指令

快速的权限控制指令：

```vue
<!-- 操作权限 -->
<el-button v-permission="'manage_students'">管理学员</el-button>

<!-- 页面权限 -->
<el-button v-permission="'/admin/campus'">校区管理</el-button>

<!-- 多权限（任意一个） -->
<el-button v-permission="['manage_students', 'manage_coaches']">
  管理功能
</el-button>
```

## 最佳实践

1. **使用路由元信息**: 在路由配置中定义权限，让路由守卫自动处理
2. **组合函数优先**: 在组件逻辑中使用 `usePermissions` 组合函数
3. **组件封装**: 对于复杂的权限逻辑，使用 `PermissionGuard` 组件
4. **指令简化**: 对于简单的显示/隐藏，使用 `v-permission` 指令
5. **错误处理**: API 错误会自动处理，无需在每个组件中重复编写

## 注意事项

1. 前端权限只是 UI 层面的控制，真正的权限验证应该在后端实现
2. 敏感操作应该在后端再次验证权限
3. 用户刷新页面时会自动检查认证状态
4. 认证失效时会自动清理本地状态并跳转登录页

## 扩展

如需添加新的权限类型或角色，请修改：

1. `utils/permissions.js` - 权限配置
2. `composables/usePermissions.js` - 权限检查逻辑
3. `stores/user.js` - 用户状态管理
4. 路由配置的 meta 信息
