# 乒乓球培训管理系统 - 第一次迭代技术文档

## 技术架构概览

### 整体架构设计

本项目采用前后端分离的架构设计，前端使用Vue 3生态系统，后端使用Kotlin + Ktor框架，数据存储采用MySQL数据库。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Vue 3)   │    │  后端 (Ktor)    │    │  数据库 (MySQL)  │
│                 │    │                 │    │                 │
│ - Element Plus  │◄──►│ - RESTful API   │◄──►│ - 用户表        │
│ - Vue Router    │    │ - Exposed ORM   │    │ - 学员表        │
│ - Pinia         │    │ - JWT Auth      │    │ - 教练表        │
│ - Axios         │    │ - Session Mgmt  │    │ - 校区表        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 前端技术实现

### 技术栈详情

| 技术组件 | 版本 | 用途 |
|---------|------|------|
| Vue | 3.5.18 | 前端框架 |
| Element Plus | 2.11.1 | UI组件库 |
| Vue Router | 4.5.1 | 路由管理 |
| Pinia | 3.0.3 | 状态管理 |
| Axios | 1.11.0 | HTTP客户端 |
| Vite | 7.0.6 | 构建工具 |

### 项目结构

```
frontend/
├── src/
│   ├── views/
│   │   ├── auth/                 # 认证相关页面
│   │   │   ├── LoginView.vue
│   │   │   ├── StudentRegisterView.vue
│   │   │   └── CoachRegisterView.vue
│   │   ├── student/              # 学员功能页面
│   │   │   ├── ScheduleView.vue
│   │   │   ├── BookTrainingView.vue
│   │   │   ├── FindCoachView.vue
│   │   │   └── StudentDashboardView.vue
│   │   ├── coach/                # 教练功能页面
│   │   │   ├── CoachDashboardView.vue
│   │   │   └── AppointmentApprovalView.vue
│   │   ├── admin/                # 管理员功能页面
│   │   │   ├── CampusManagementView.vue
│   │   │   ├── DataExportView.vue
│   │   │   └── SystemLogsView.vue
│   │   └── campus/               # 校区管理页面
│   │       ├── AppointmentManagementView.vue
│   │       ├── CoachManagementView.vue
│   │       └── StudentManagementView.vue
│   ├── components/
│   │   ├── dashboard/            # 仪表盘组件
│   │   │   ├── StudentDashboard.vue
│   │   │   ├── CoachDashboard.vue
│   │   │   ├── CampusAdminDashboard.vue
│   │   │   ├── SuperAdminDashboard.vue
│   │   │   └── DefaultDashboard.vue
│   │   ├── AppSidebar.vue        # 侧边栏组件
│   │   └── PagePlaceholder.vue   # 页面占位符
│   ├── layouts/
│   │   └── MainLayout.vue        # 主布局组件
│   ├── router/
│   │   └── index.js              # 路由配置
│   ├── stores/
│   │   ├── user.js               # 用户状态管理
│   │   └── counter.js
│   ├── utils/
│   │   ├── api.js                # API接口封装
│   │   └── permissions.js        # 权限管理工具
│   └── assets/                   # 静态资源
```

### 核心功能实现

#### 1. 路由配置 (router/index.js)

```javascript
const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    // 认证相关路由
    {
      path: '/login',
      name: 'Login',
      component: () => import('@/views/auth/LoginView.vue'),
      meta: { requiresAuth: false },
    },
    {
      path: '/register/student',
      name: 'StudentRegister', 
      component: () => import('@/views/auth/StudentRegisterView.vue'),
      meta: { requiresAuth: false },
    },
    // 主应用路由...
  ]
})
```

#### 2. 状态管理 (stores/user.js)

```javascript
export const useUserStore = defineStore('user', {
  state: () => ({
    user: null,
    token: null,
    isAuthenticated: false,
  }),
  
  actions: {
    async login(credentials) {
      // 登录逻辑实现
    },
    
    async register(userData) {
      // 注册逻辑实现  
    },
    
    logout() {
      // 登出逻辑实现
    }
  }
})
```

#### 3. API接口封装 (utils/api.js)

```javascript
const api = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000,
})

// 请求拦截器
api.interceptors.request.use(config => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// 响应拦截器  
api.interceptors.response.use(
  response => response.data,
  error => {
    // 统一错误处理
    return Promise.reject(error)
  }
)
```

## 后端技术实现

### 技术栈详情

| 技术组件 | 版本 | 用途 |
|---------|------|------|
| Kotlin | 2.1.10 | 编程语言 |
| Ktor | 3.2.3 | Web框架 |
| Exposed | 0.56.0 | ORM框架 |
| MySQL | 8.0 | 数据库 |
| HikariCP | 5.1.0 | 连接池 |
| BCrypt | 0.4 | 密码加密 |

### 项目结构

```
backend/
├── src/main/kotlin/io/github/shaoyuanyu/ttts/
│   ├── Application.kt            # 应用程序入口
│   ├── dto/
│   │   └── user/                 # 用户数据传输对象
│   │       ├── User.kt
│   │       ├── UserRole.kt
│   │       └── UserSession.kt
│   ├── persistence/
│   │   ├── UserService.kt        # 用户服务类
│   │   ├── user/                 # 用户数据层
│   │   ├── student/              # 学员数据层
│   │   ├── coach/                # 教练数据层
│   │   └── campus/               # 校区数据层
│   ├── routes/
│   │   └── UserRoutes.kt         # 用户路由
│   ├── plugins/
│   │   ├── Database.kt           # 数据库配置
│   │   ├── Authentication.kt     # 认证配置
│   │   ├── Routing.kt            # 路由配置
│   │   └── Serialization.kt      # 序列化配置
│   └── utils/
│       └── Encrypt.kt            # 加密工具
```

### 核心功能实现

#### 1. 应用程序配置 (Application.kt)

```kotlin
fun Application.configureApplication() {
    configureDatabase()
    configureSerialization()
    configureAuthentication()
    configureSessions()
    configureRouting()
}

fun main() {
    embeddedServer(Netty, port = 8080, host = "0.0.0.0") {
        configureApplication()
    }.start(wait = true)
}
```

#### 2. 数据库表定义 (persistence/user/UserTable.kt)

```kotlin
object UserTable : UUIDTable("user") {
    val username = varchar("username", 64).uniqueIndex()
    val encrypted_password = text("encrypted_password")
    val real_name = varchar("real_name", 128)
    val gender = varchar("gender", 32)
    val age = integer("age")
    val phone_number = varchar("phone_number", 16)
    val email = varchar("email", 128)
    val campus_id = integer("campus_id")
    val role = customEnumeration(
        name = "role",
        sql = "ENUM('SUPER_ADMIN', 'CAMPUS_ADMIN', 'COACH', 'STUDENT')",
        fromDb = { value -> UserRole.valueOf(value as String) },
        toDb = { it.name }
    )
    val status = varchar("status", 32)
    val created_at = timestamp("created_at")
    val last_login_at = timestamp("last_login_at")
}
```

#### 3. 用户服务实现 (persistence/UserService.kt)

```kotlin
class UserService(private val database: Database) {
    
    fun createUser(newUser: User): String =
        transaction(database) {
            UserEntity.new {
                username = newUser.username
                encryptedPassword = encryptPasswd(newUser.plainPassword!!)
                realName = newUser.realName
                // ... 其他字段赋值
            }.id.value.toString()
        }
    
    fun validateUser(username: String, plainPassword: String): String =
        transaction(database) {
            UserEntity.find { UserTable.username eq username }
                .first()
                .let { user ->
                    if (validatePasswd(plainPassword, user.encryptedPassword)) {
                        user.id.value.toString()
                    } else {
                        throw Exception("密码错误")
                    }
                }
        }
}
```

#### 4. API路由定义 (routes/UserRoutes.kt)

```kotlin
fun Application.userRoutes(userService: UserService) {
    routing {
        route("/user") {
            // 注册接口
            post("/signup") {
                val newUser = call.receive<User>()
                val userId = userService.createUser(newUser)
                call.sessions.set(
                    UserSession(userId, newUser.username, newUser.role)
                )
                call.respondText("signup success")
            }
            
            // 登录接口
            authenticate("auth-form") {
                post("/login") {
                    val userId = call.principal<UserIdPrincipal>()?.name
                    val user = userService.queryUserByUUID(userId!!)
                    call.sessions.set(
                        UserSession(userId, user.username, user.role)
                    )
                    call.respond(user)
                }
            }
        }
    }
}
```

## 数据库设计

### 数据库表结构

#### 1. 用户表 (user)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | UUID | 主键 | PRIMARY KEY |
| username | VARCHAR(64) | 用户名 | UNIQUE |
| encrypted_password | TEXT | 加密密码 | NOT NULL |
| real_name | VARCHAR(128) | 真实姓名 | NOT NULL |
| gender | VARCHAR(32) | 性别 | |
| age | INT | 年龄 | |
| phone_number | VARCHAR(16) | 手机号 | |
| email | VARCHAR(128) | 邮箱 | |
| campus_id | INT | 校区ID | FOREIGN KEY |
| role | ENUM | 用户角色 | NOT NULL |
| status | VARCHAR(32) | 用户状态 | |
| created_at | TIMESTAMP | 创建时间 | NOT NULL |
| last_login_at | TIMESTAMP | 最后登录时间 | |

#### 2. 学员表 (student)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | UUID | 主键 | PRIMARY KEY |
| username | VARCHAR(64) | 用户名 | FOREIGN KEY |
| balance | FLOAT | 账户余额 | DEFAULT 0 |
| created_at | DATETIME | 创建时间 | NOT NULL |
| last_login_at | DATETIME | 最后登录时间 | |

#### 3. 教练表 (coach)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | UUID | 主键 | PRIMARY KEY |
| username | VARCHAR(64) | 用户名 | FOREIGN KEY |
| photo_url | VARCHAR(128) | 头像URL | |
| achievements | VARCHAR(128) | 成就描述 | |
| level_ | VARCHAR(32) | 教练等级 | |
| hourly_rate | FLOAT | 时薪 | |
| max_students | INT | 最大学员数 | DEFAULT 20 |
| current_students | INT | 当前学员数 | DEFAULT 0 |
| is_approved | BOOLEAN | 是否审核通过 | DEFAULT FALSE |
| approved_by | INT | 审核人ID | |
| created_at | DATETIME | 创建时间 | NOT NULL |
| last_login_at | DATETIME | 最后登录时间 | |

### 数据库关系图

```
    ┌─────────────┐
    │    User     │
    │             │
    │ - id (PK)   │
    │ - username  │
    │ - password  │
    │ - role      │
    └─────┬───────┘
          │
    ┌─────┴───────┐
    │             │
┌───▼───┐   ┌─────▼─────┐
│Student│   │   Coach   │
│       │   │           │
│- id   │   │ - id      │
│- balance  │ - level_  │
└───────┘   │ - rate    │
            └───────────┘
```

## 安全机制

### 1. 密码安全

- 使用BCrypt算法进行密码加密
- 自动生成盐值，防止彩虹表攻击
- 密码强度验证

```kotlin
fun encryptPasswd(plainPassword: String): String {
    return BCrypt.hashpw(plainPassword, BCrypt.gensalt())
}

fun validatePasswd(plainPassword: String, hashedPassword: String): Boolean {
    return BCrypt.checkpw(plainPassword, hashedPassword)
}
```

### 2. 会话管理

- 基于Session的用户状态管理
- 自动会话超时机制
- 会话安全配置

```kotlin
install(Sessions) {
    cookie<UserSession>("user_session") {
        cookie.secure = false // 开发环境设置
        cookie.httpOnly = true
        cookie.maxAgeInSeconds = 3600 // 1小时超时
    }
}
```

### 3. 输入验证

- 前端表单验证
- 后端数据验证
- SQL注入防护（ORM保护）

## 性能优化

### 1. 数据库优化

- 使用HikariCP连接池
- 数据库索引优化
- 查询语句优化

```kotlin
Database.connect(
    url = "jdbc:mysql://localhost:3306/ttts",
    driver = "com.mysql.cj.jdbc.Driver",
    user = "root",
    password = "password"
)
```

### 2. 前端优化

- 组件懒加载
- 资源压缩打包
- CDN静态资源托管

```javascript
// 路由懒加载
const LoginView = () => import('@/views/auth/LoginView.vue')
```

## 部署配置

### Docker配置 (docker-compose.yml)

```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: ttts
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  backend:
    build: ./backend
    ports:
      - "8080:8080"
    depends_on:
      - mysql
    environment:
      DATABASE_URL: jdbc:mysql://mysql:3306/ttts

  frontend:
    build: ./frontend
    ports:
      - "5173:5173"
    depends_on:
      - backend

volumes:
  mysql_data:
```

## 开发工具配置

### 1. 前端开发环境

```json
// package.json scripts
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "test:unit": "vitest",
    "lint": "eslint . --fix"
  }
}
```

### 2. 后端开发环境

```kotlin
// build.gradle.kts
plugins {
    kotlin("jvm") version "2.1.10"
    id("io.ktor.plugin") version "3.2.3"
    kotlin("plugin.serialization") version "2.2.0"
}
```

## API接口文档

### 用户相关接口

#### 用户注册
- **接口**: `POST /user/signup`
- **参数**: 
```json
{
  "username": "string",
  "plainPassword": "string", 
  "realName": "string",
  "gender": "string",
  "age": 18,
  "phoneNumber": "string",
  "email": "string",
  "campusId": 1,
  "role": "STUDENT|COACH"
}
```
- **响应**: 
```json
{
  "message": "signup success"
}
```

#### 用户登录
- **接口**: `POST /user/login`
- **参数**: `username`, `password` (form-data)
- **响应**: 用户信息对象

## 测试策略

### 1. 单元测试

- 前端: Vitest + Vue Test Utils
- 后端: JUnit + Kotlin Test

### 2. 集成测试

- API接口测试
- 数据库集成测试

### 3. 端到端测试

- 用户注册登录流程测试
- 关键业务场景测试

## 监控与日志

### 1. 日志配置

```xml
<!-- logback.xml -->
<configuration>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>
```

### 2. 操作日志

- 用户登录/注册日志
- 数据库操作日志
- 错误异常日志

## 总结

本次迭代成功建立了完整的技术架构，实现了基础的用户管理功能。技术选型合理，代码结构清晰，为后续功能开发奠定了坚实的基础。

### 已实现的核心功能

#### 前端功能
1. **完整的用户界面系统**
   - 登录/注册页面（支持学员和教练注册）
   - 多角色仪表盘（学员、教练、校区管理员、超级管理员）
   - 学员课表系统（支持周视图/月视图切换）
   - 响应式布局设计

2. **课表管理系统**
   - 可视化课程安排展示
   - 支持不同视图模式切换
   - 课程状态管理
   - 时间线展示

3. **仪表盘功能**
   - 数据统计展示
   - 今日课程安排
   - 个人信息管理
   - 快捷操作入口

#### 后端功能
1. **用户认证系统**
   - 用户注册（学员/教练）
   - 用户登录验证
   - 密码安全加密
   - 会话管理

2. **数据库设计**
   - 完整的用户数据模型
   - 多角色权限系统
   - 关系型数据结构
   - 数据持久化

3. **API接口**
   - RESTful API设计
   - 统一响应格式
   - 错误处理机制
   - OpenAPI文档

### 技术亮点

1. **现代化技术栈**: Vue 3 + Kotlin + Ktor
2. **组件化开发**: 高度模块化的前端组件
3. **安全设计**: BCrypt密码加密，会话管理
4. **可扩展架构**: 清晰的分层架构，易于扩展
5. **开发工具**: 完善的开发环境配置

本次迭代为乒乓球培训管理系统奠定了坚实的技术基础，后续开发可以在此基础上快速迭代。
