# 乒乓球培训管理系统 开发总结报告（迭代01-02）

本文基于现有前后端代码、配置、迭代文档（迭代01/02）、git 提交记录与近期运行日志进行归纳，形成阶段性开发总结与改进建议。

## 摘要
- 目标与范围：面向培训机构的学员/教练/校区多角色管理，涵盖登录鉴权、权限控制、课程排期、互选、消息、钱包等模块，支持 Docker 本地编排。
- 当前状态：前后端主体功能已成型，RBAC 生效，主要业务链路可用（钱包余额/流水、互选、排期、竞赛、管理端列表等）。运行日志显示系统可稳定启动与对外服务。
- 发现的问题（具象）：
  - OpenAPI 启动大量 “Empty operationId” 警告。
  - 前端重复拼接查询字符串（如 `?page=1&size=20?page=1&size=20`）。
  - 个别接口路径/参数不一致导致 404（如 `GET /student/balance`、`GET /student/coaches/available?level=&specialty=?level=&specialty=`）。
  - 预期内的 401（未登录访问受限资源）。
- 优先改进建议：
  1) 统一前端查询参数构造；2) 明确并对齐 `/student/*` 相关 API；3) 为 OpenAPI 明确 operationId；4) 增补关键用例的端到端回归用例。

## 时间线与里程碑（简要）
- 时间范围：基于 git 自 2025-09-01 起的提交与迭代文档（迭代01：2025-09-07；迭代02：2025-09-13）。
- 主要推进：
  - 架构与基础设施：Ktor 后端、Vue3 前端搭建，Docker Compose 一体化运行，MySQL 初始化与健康检查。
  - 功能线：权限体系（SUPER_ADMIN/CAMPUS_ADMIN/COACH/STUDENT）、课程/排期、教练学员互选、消息中心、钱包收支、竞赛模块等的持续完善。
  - 文档与演示：根/前后端 README、迭代文档与测试报告同步更新。

## 架构与技术栈
- 前端：
  - Vue 3.5.x、Vue Router 4.5.x、Pinia 3.0.x、Element Plus 2.11.x、Axios 1.11.x、Day.js 1.11.x。
  - 构建：Vite 7；Node 要求 ^20.19.0 或 >=22.12.0；别名 `@ -> src`；开发代理 `/api -> VITE_API_BASE_URL`。
- 后端：
  - Kotlin JVM 2.1.x、Ktor 3.2.x（auth/cors/sessions/status-pages/content-negotiation/call-logging/openapi/swagger）。
  - 数据访问：Exposed 0.56.x、HikariCP 5.1.x、MySQL 8.x；日志：Logback；安全：jBCrypt。
- 部署/运维：
  - docker-compose 编排应用与数据库，支持 `.env` 管理；后端多阶段构建；本地要求 JDK 17+ 与 Node 20+。
- 权限与会话：基于会话的认证，RBAC 四角色分权；REST API 风格。

## 关键功能与完成度（结合日志与代码）
- 认证与权限：
  - 未登录访问受限资源返回 401（预期）；登录后访问如 `/user/info`、`/courses/my-schedule` 正常 200。
- 钱包：
  - 余额查询与流水查询均返回 200，日志示例：“余额：600.0”；充值/扣费流水记录存在（如 `-200`、`+1000`）。
- 互选：
  - 列表查询返回 200；`POST /mutual-selection/apply` 在超过上限时返回业务 400（“学生已达到最大可选教练数”）。
- 课程与排期、竞赛：
  - 我的课表、竞赛列表等返回 200，运行路径通畅。
- 管理端：
  - 如 `/admin/students` 列表访问频繁，返回稳定（存在查询串重复但后端仍兼容处理）。

## 质量与测试
- 文档：`documents/` 下迭代与测试报告齐备，覆盖需求、实现与风险。
- 自动化：前端存在 Vitest 配置与用例（如 `frontend/tests/bookTrainingUtils.test.js`），建议扩展到端到端路径（登录→功能操作→结果校验）。
- 可观测性：后端启用 `call-logging`；启动生成 OpenAPI/Swagger 文档；建议补充请求追踪 ID 与基础性能指标。

## 运行与运维信号（来自近期日志）
- 启动：应用正常启动并监听 8080；Swagger 文档生成，伴随大量 `Empty operationId` 警告。
- 访问特征：
  - 频繁 200：`/campus/names`、`/admin/students`、`/mutual-selection/all` 等。
  - 预期 401：登录前访问受限资源。
  - 404：`GET /student/balance`、`GET /student/coaches/available?level=&specialty=?level=&specialty=`（接口定义/参数构造待统一）。
  - 查询参数重复：如 `?page=1&size=20?page=1&size=20` 出现在多个 GET 请求。

## 主要问题与优化建议（可落地清单）
1) OpenAPI 警告清理：
   - 为每个路由显式配置 `operationId`，并补充必要的 `summary/description` 与响应示例。
2) 前端查询参数构造修复：
   - 统一使用 URLSearchParams 或 axios params 规范化参数；避免模板字符串手动拼接；去重空值参数。
   - 在 `utils/api.js` 或请求封装处添加参数规范化中间层与防重复检测。
3) 接口路径与契约对齐：
   - 明确学生钱包、教练检索等 REST 路径并在前端统一引用；补充后端 `404` 的结构化错误体，便于前端回退处理。
4) 回归与端到端用例：
   - 针对登录→钱包→互选→排期的闭环编写端到端用例；覆盖分页、空参数、越界等边界场景。
5) 可观测性与稳定性：
   - 请求/响应日志增加 traceId；关键接口添加简单时延指标与错误率统计；对重复查询参数与 4xx/5xx 建立告警。

## 风险与技术债
- 契约一致性风险：多端对接口的理解差异导致 404 与参数错误。
- 文档/示例不足：OpenAPI 警告与缺失示例会影响前端对接与测试生成。
- 测试覆盖不足：端到端链路与异常路径覆盖度有限。

## 下一步计划（两周建议排程）
- 第1周：
  - 完成查询参数构造修复与公共封装；对齐 `/student/*` 与教练检索接口；补齐 OpenAPI operationId 与示例。
- 第2周：
  - 编写并接入端到端回归；增加日志 traceId 与基础指标；梳理告警阈值并验证。

## 附录
- 版本清单（节选）：
  - 前端：Vue 3.5.x / Router 4.5.x / Pinia 3.0.x / Element Plus 2.11.x / Axios 1.11.x / Vite 7 / Node >=20.19。
  - 后端：Kotlin 2.1.x / Ktor 3.2.x / Exposed 0.56.x / HikariCP 5.1.x / MySQL 8.x / Logback / jBCrypt。
- 参考与证据：
  - 配置与依赖：`backend/build.gradle.kts`、`frontend/package.json`、`frontend/vite.config.js`、`docker-compose.yml`。
  - 运行日志：`logs/application.2025-09-24.0.log`、`logs/application.2025-09-25.0.log`、`logs/application.log`。
  - 迭代与测试文档：`documents/迭代01_20250907/*`、`documents/迭代02_20250913/*`、`documents/测试报告.*`。

---
说明：本报告不包含敏感数据，只引用已入库的公共文档与日志要点；若需导出 PDF 或加入 `docs/` 站点，请告知目标格式与版式要求。
