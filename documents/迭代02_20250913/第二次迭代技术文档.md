# 乒乓球培训管理系统 - 第二次迭代技术文档

## 技术架构概览

### 整体架构设计

第二次迭代在第一次的基础上进行了重大升级，形成了更加成熟和完善的技术架构。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Vue 3)   │    │  后端 (Ktor)    │    │  数据库 (MySQL)  │
│                 │    │                 │    │                 │
│ - 设计系统      │◄──►│ - RESTful API   │◄──►│ - 用户管理      │
│ - 权限管理      │    │ - 消息系统      │    │ - 消息系统      │
│ - 消息中心      │    │ - 充值系统      │    │ - 充值记录      │
│ - 环境配置      │    │ - 校区管理      │    │ - 校区管理      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 前端技术实现

### 技术栈升级

| 技术组件 | 版本 | 新增功能 |
|---------|------|----------|
| Vue | 3.5.18 | 设计系统集成 |
| Element Plus | 2.11.1 | 组件定制化 |
| Vue Router | 4.5.1 | 权限路由守卫 |
| Pinia | 3.0.3 | 消息状态管理 |
| Vite | 7.0.6 | 环境变量管理 |

### 设计系统实现

#### 1. Glassmorphism 核心样式

```css
/* 核心设计变量 */
:root {
  /* 透明度系统 */
  --white-alpha-10: rgba(255, 255, 255, 0.1);
  --white-alpha-15: rgba(255, 255, 255, 0.15);
  --white-alpha-20: rgba(255, 255, 255, 0.2);
  --white-alpha-30: rgba(255, 255, 255, 0.3);
  
  /* 毛玻璃效果 */
  --blur-sm: blur(4px);
  --blur-md: blur(8px);
  --blur-lg: blur(16px);
  --blur-xl: blur(24px);
  
  /* 阴影系统 */
  --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.12);
  --shadow-elevated: 0 16px 48px rgba(0, 0, 0, 0.2);
}

/* 玻璃卡片基础样式 */
.glass-card {
  background: var(--white-alpha-15);
  backdrop-filter: var(--blur-xl);
  border: 1px solid var(--white-alpha-20);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-glass);
  transition: var(--transition-slow);
}
```

#### 2. 组件库体系

**GlassCard 系列组件**:

```vue
<!-- GlassDisplayCard - 展示型卡片 -->
<GlassDisplayCard
  title="组件标题"
  subtitle="副标题"
  icon="🎯"
  description="组件描述信息"
  type="glass"
  :tags="[{ text: '标签', type: 'primary' }]"
>
  <div>内容区域</div>
</GlassDisplayCard>

<!-- GlassCardWithHeader - 带头部的卡片 -->
<GlassCardWithHeader 
  title="卡片标题" 
  icon="🔧" 
  type="primary"
>
  <StatusGrid :items="statusItems" />
</GlassCardWithHeader>
```

**ModernButton 组件**:

```vue
<!-- 现代化按钮 -->
<ModernButton 
  text="按钮文字" 
  type="primary" 
  size="large"
  :loading="false"
  :disabled="false"
  @click="handleClick"
/>
```

### 前后端对接实现

#### 1. 环境配置系统

```javascript
// .env.development
VITE_API_BASE_URL=http://localhost:8080
VITE_ENABLE_DEBUG=true
VITE_LOG_LEVEL=debug

// .env.production  
VITE_API_BASE_URL=https://api.ttts.com
VITE_ENABLE_DEBUG=false
VITE_LOG_LEVEL=error

// 使用方式
const apiBaseUrl = import.meta.env.VITE_API_BASE_URL
```

#### 2. 权限管理系统

```javascript
// composables/usePermissions.js
export function usePermissions() {
  const userStore = useUserStore()
  
  const canPerformAction = (action) => {
    return hasActionPermission(action, userStore.userRole)
  }
  
  const requireAuth = () => {
    if (!userStore.isLoggedIn) {
      router.push('/login')
      return false
    }
    return true
  }
  
  return {
    canPerformAction,
    requireAuth,
    isSuperAdmin: computed(() => userStore.isSuperAdmin),
    isCampusAdmin: computed(() => userStore.isCampusAdmin),
    isStudent: computed(() => userStore.isStudent),
    isCoach: computed(() => userStore.isCoach)
  }
}
```

#### 3. 消息系统实现

```javascript
// stores/messageStore.js
export const useMessageStore = defineStore('messages', () => {
  const messages = ref([])
  const unreadCount = computed(() => 
    messages.value.filter(msg => !msg.read).length
  )
  
  const fetchMessages = async (params = {}) => {
    const res = await apiFetchMessages(params)
    messages.value = res.data || []
  }
  
  const markAsRead = async (id) => {
    await markMessageAsRead(id)
    const message = messages.value.find(msg => msg.id === id)
    if (message) message.read = true
  }
  
  return {
    messages,
    unreadCount,
    fetchMessages,
    markAsRead
  }
})
```

## 后端技术实现

### 技术栈扩展

| 技术组件 | 版本 | 新增功能 |
|---------|------|----------|
| Kotlin | 2.1.10 | 业务逻辑扩展 |
| Ktor | 3.2.3 | 消息系统API |
| Exposed | 0.56.0 | 充值记录管理 |
| MySQL | 8.0 | 数据表扩展 |

### 新增数据库设计

#### 1. 消息系统表结构

```sql
-- 消息表
CREATE TABLE message (
    id VARCHAR(36) PRIMARY KEY,
    recipient_id VARCHAR(36) NOT NULL,
    sender_id VARCHAR(36),
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    type ENUM('SYSTEM', 'APPOINTMENT', 'EVALUATION', 'USER', 'EVENT', 'REMINDER') NOT NULL,
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (recipient_id) REFERENCES user(id),
    FOREIGN KEY (sender_id) REFERENCES user(id)
);
```

#### 2. 充值记录表结构

```sql
-- 充值记录表
CREATE TABLE recharge (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    amount FLOAT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user(id)
);
```

### API接口设计

#### 1. 消息系统API

```kotlin
// 消息路由配置
fun Application.messageRoutes(messageService: MessageService) {
    routing {
        route("/messages") {
            authenticate("auth-session-all") {
                get { getMessages(messageService) }
                get("/unread-count") { getUnreadCount(messageService) }
                put("/{id}/read") { markMessageAsRead(messageService) }
                put("/read-all") { markAllMessagesAsRead(messageService) }
                delete("/{id}") { deleteMessage(messageService) }
            }
            
            authenticate("auth-session-super-admin") {
                post { sendMessage(messageService) }
            }
        }
    }
}

// 获取消息列表实现
fun Route.getMessages(messageService: MessageService) {
    get {
        val userId = call.sessions.get<UserSession>()?.userId
            ?: throw UnauthorizedException("未登录")
            
        val type = call.request.queryParameters["type"]
        val unreadOnly = call.request.queryParameters["unreadOnly"]?.toBoolean() ?: false
        val page = call.request.queryParameters["page"]?.toIntOrNull() ?: 0
        val size = call.request.queryParameters["size"]?.toIntOrNull() ?: 20
        
        val messages = messageService.getMessages(userId, type, unreadOnly, page, size)
        call.respond(HttpStatusCode.OK, messages)
    }
}
```

#### 2. 钱包充值API

```kotlin
// 钱包路由配置
fun Application.walletRoutes(walletService: StudentService) {
    routing {
        route("/wallet") {
            authenticate("auth-session-all") {
                get("/balance") { getWalletBalance(walletService) }
                get("/recharge/history") { getRechargeHistory(walletService) }
            }
            
            authenticate("auth-session-student") {
                post("/recharge") { rechargeWallet(walletService) }
            }
            
            authenticate("auth-session-super-admin") {
                get("/recharge/records") { getAllRechargeRecords(walletService) }
                get("/recharge/records/{username}") { getRechargeRecordsByUserId(walletService) }
            }
        }
    }
}

// 充值功能实现
fun Route.rechargeWallet(walletService: StudentService) {
    post("/recharge") {
        val userId = call.sessions.get<UserSession>()?.userId
            ?: throw UnauthorizedException("未登录")
            
        val userRole = call.sessions.get<UserSession>()?.userRole
        if (userRole != UserRole.STUDENT) {
            throw BadRequestException("只有学生可以进行充值")
        }
        
        val rechargeRequest = call.receive<RechargeRequest>()
        val amount = rechargeRequest.amount
        
        // 参数验证
        if (amount <= 0) {
            throw BadRequestException("充值金额必须大于0")
        }
        if (amount > 10000) {
            throw BadRequestException("单次充值金额不能超过10000元")
        }
        
        // 执行充值
        walletService.recharge(userId, amount)
        val newBalance = walletService.queryBalance(userId)
        
        call.respond(HttpStatusCode.OK, mapOf("balance" to newBalance))
    }
}
```

#### 3. 校区管理API

```kotlin
// 校区路由配置
fun Application.campusRoutes(campusService: CampusService) {
    routing {
        route("/campus") {
            authenticate("auth-session-all") {
                get("/list") { getCampusList(campusService) }
            }
            
            authenticate("auth-session-super-admin") {
                post { createCampus(campusService) }
            }
        }
    }
}
```

### 业务逻辑层实现

#### 1. 消息服务

```kotlin
class MessageService(private val database: Database) {
    
    fun getMessages(
        userId: String, 
        type: String?, 
        unreadOnly: Boolean, 
        page: Int, 
        size: Int
    ): MessageListResponse = transaction(database) {
        
        var query = MessageEntity.find { MessageTable.recipientId eq userId }
        
        // 类型过滤
        if (type != null) {
            query = query.andWhere { MessageTable.type eq MessageType.valueOf(type) }
        }
        
        // 未读过滤
        if (unreadOnly) {
            query = query.andWhere { MessageTable.isRead eq false }
        }
        
        val totalCount = query.count()
        val messages = query
            .orderBy(MessageTable.createdAt to SortOrder.DESC)
            .limit(size, (page * size).toLong())
            .map { it.expose() }
            
        MessageListResponse(
            data = messages,
            totalCount = totalCount,
            page = page,
            size = size,
            totalPages = (totalCount + size - 1) / size
        )
    }
    
    fun markAsRead(messageId: String, userId: String) = transaction(database) {
        val message = MessageEntity.findById(UUID.fromString(messageId))
            ?: throw Exception("消息不存在")
            
        if (message.recipientId != userId) {
            throw Exception("无权限访问此消息")
        }
        
        message.isRead = true
        message.updatedAt = Clock.System.now()
    }
}
```

#### 2. 学员服务扩展

```kotlin
class StudentService(
    private val database: Database,
    private val userService: UserService
) {
    
    fun recharge(uuid: String, amount: Float) = transaction(database) {
        val student = StudentEntity.findById(UUID.fromString(uuid))
            ?: throw Exception("用户不存在")
            
        student.balance += amount
        
        // 创建充值记录
        RechargeEntity.new {
            this.userId = uuid
            this.amount = amount
            this.createdAt = Clock.System.now()
        }
        
        LOGGER.info("充值成功，用户 ID：$uuid，金额：$amount，余额：${student.balance}")
    }
    
    fun getRechargeHistory(userId: String, page: Int, size: Int): Pair<List<RechargeRecord>, Long> = 
        transaction(database) {
            val query = RechargeEntity.find { RechargeTable.userId eq userId }
            val totalCount = query.count()
            
            val records = query
                .orderBy(RechargeTable.createdAt to SortOrder.DESC)
                .limit(size, ((page - 1) * size).toLong())
                .map { it.expose() }
                
            records to totalCount
        }
}
```

## 权限控制系统

### 认证机制

#### 1. Session 认证配置

```kotlin
// 认证配置
install(Authentication) {
    session<UserSession>("auth-session-all") {
        validate { session ->
            if (session.userId.isNotEmpty()) {
                UserIdPrincipal(session.userId)
            } else null
        }
        challenge {
            throw UnauthorizedException("未登录")
        }
    }
    
    session<UserSession>("auth-session-super-admin") {
        validate { session ->
            if (session.userId.isNotEmpty() && session.userRole == UserRole.SUPER_ADMIN) {
                UserIdPrincipal(session.userId)
            } else null
        }
        challenge {
            throw ForbiddenException("权限不足")
        }
    }
}
```

#### 2. 多级权限验证

```kotlin
// 权限验证中间件
fun Route.requireRole(vararg roles: UserRole, block: Route.() -> Unit) {
    intercept(ApplicationCallPipeline.Call) {
        val session = call.sessions.get<UserSession>()
        if (session == null || session.userRole !in roles) {
            throw ForbiddenException("权限不足")
        }
    }
    block()
}

// 使用示例
route("/admin") {
    requireRole(UserRole.SUPER_ADMIN, UserRole.CAMPUS_ADMIN) {
        get("/users") { getUserList() }
    }
}
```

## 异常处理系统

### 统一异常处理

```kotlin
// 自定义异常类
class UnauthorizedException(message: String) : Exception(message)
class ForbiddenException(message: String) : Exception(message)
class BadRequestException(message: String) : Exception(message)

// 状态页面配置
install(StatusPages) {
    exception<UnauthorizedException> { call, cause ->
        call.respond(HttpStatusCode.Unauthorized, cause.message ?: "未授权")
    }
    
    exception<ForbiddenException> { call, cause ->
        call.respond(HttpStatusCode.Forbidden, cause.message ?: "权限不足")
    }
    
    exception<BadRequestException> { call, cause ->
        call.respond(HttpStatusCode.BadRequest, cause.message ?: "请求参数错误")
    }
    
    exception<Exception> { call, cause ->
        call.application.environment.log.error("Unhandled exception", cause)
        call.respond(HttpStatusCode.InternalServerError, "服务器内部错误")
    }
}
```

## 性能优化

### 1. 前端优化

**组件懒加载**:
```javascript
// 路由懒加载
const routes = [
  {
    path: '/messages',
    component: () => import('@/views/MessagesView.vue')
  }
]

// 组件动态导入
const GlassCard = defineAsyncComponent(() => 
  import('@/components/GlassCard.vue')
)
```

**CSS 优化**:
```css
/* 硬件加速 */
.glass-card {
  transform: translateZ(0);
  will-change: transform, opacity;
}

/* 动画优化 */
@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.shimmer-effect::before {
  animation: shimmer 2s infinite;
  transform: translateZ(0);
}
```

### 2. 后端优化

**数据库查询优化**:
```kotlin
// 分页查询优化
fun getMessages(userId: String, page: Int, size: Int) = transaction(database) {
    // 使用索引优化查询
    MessageEntity.find { 
        MessageTable.recipientId eq userId 
    }
    .orderBy(MessageTable.createdAt to SortOrder.DESC)
    .limit(size, (page * size).toLong())
    .map { it.expose() }
}

// 批量操作优化
fun markAllAsRead(userId: String) = transaction(database) {
    MessageTable.update({ 
        MessageTable.recipientId eq userId and 
        MessageTable.isRead eq false 
    }) {
        it[isRead] = true
        it[updatedAt] = Clock.System.now()
    }
}
```

## 开发工具与调试

### 1. 开发工具页面

```vue
<!-- DevToolsView.vue -->
<template>
  <div class="dev-tools">
    <!-- 环境信息 -->
    <GlassCardWithHeader title="环境信息" icon="🔧">
      <StatusGrid :items="envItems" />
    </GlassCardWithHeader>
    
    <!-- API测试 -->
    <GlassCardWithHeader title="API测试" icon="🔗">
      <div class="api-test">
        <el-button @click="testLogin">测试登录</el-button>
        <el-button @click="testMessages">测试消息</el-button>
        <el-button @click="testRecharge">测试充值</el-button>
      </div>
    </GlassCardWithHeader>
    
    <!-- 权限测试 -->
    <GlassCardWithHeader title="权限测试" icon="🔐">
      <StatusGrid :items="permissionItems" />
    </GlassCardWithHeader>
  </div>
</template>
```

### 2. 请求监控

```kotlin
// 请求日志插件
install(CallLogging) {
    level = Level.INFO
    format { call ->
        val status = call.response.status()
        val httpMethod = call.request.httpMethod.value
        val userAgent = call.request.headers["User-Agent"]
        "Status: $status, HTTP method: $httpMethod, User agent: $userAgent"
    }
    
    filter { call ->
        call.request.path().startsWith("/api")
    }
}

// 性能监控
install(CallId) {
    header(HttpHeaders.XRequestId)
    generate { "req-${System.currentTimeMillis()}" }
}
```

## 安全性增强

### 1. 输入验证

```kotlin
// 数据验证
data class RechargeRequest(
    val amount: Float
) {
    init {
        require(amount > 0) { "充值金额必须大于0" }
        require(amount <= 10000) { "单次充值金额不能超过10000元" }
    }
}

// 用户输入过滤
fun sanitizeInput(input: String): String {
    return input.trim()
        .replace(Regex("[<>\"'&]"), "")
        .take(255)
}
```

### 2. CORS 配置

```kotlin
install(CORS) {
    allowMethod(HttpMethod.Options)
    allowMethod(HttpMethod.Put)
    allowMethod(HttpMethod.Delete)
    allowMethod(HttpMethod.Patch)
    allowHeader(HttpHeaders.Authorization)
    allowHeader(HttpHeaders.ContentType)
    allowCredentials = true
    
    // 开发环境
    if (isDevelopment) {
        anyHost()
    } else {
        // 生产环境指定域名
        allowHost("ttts.com", schemes = listOf("https"))
    }
}
```

## API 文档系统

### OpenAPI 集成

```kotlin
// OpenAPI 插件配置
install(OpenAPI) {
    path = "/openapi"
    swaggerUI {
        version = SwaggerVersions.V4_15_5
    }
}

// API 文档示例
/**
 * @api {post} /wallet/recharge 学生充值钱包
 * @apiGroup 钱包系统
 * @apiDescription 学生用户进行钱包充值
 * 
 * @apiParam {Number} amount 充值金额，必须大于0且不超过10000
 * 
 * @apiSuccess {Number} balance 充值后的账户余额
 * 
 * @apiError (400) BadRequest 请求参数错误
 * @apiError (401) Unauthorized 未认证
 * @apiError (403) Forbidden 权限不足
 */
```

## 部署配置

### Docker 容器化

```yaml
# docker-compose.yml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ttts
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql

  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    depends_on:
      - mysql
    environment:
      DATABASE_URL: jdbc:mysql://mysql:3306/ttts
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend
    environment:
      VITE_API_BASE_URL: http://backend:8080
```

## 监控与日志

### 应用监控

```kotlin
// 健康检查端点
routing {
    get("/health") {
        call.respond(HttpStatusCode.OK, mapOf(
            "status" to "UP",
            "timestamp" to Clock.System.now(),
            "database" to checkDatabaseHealth(),
            "memory" to getMemoryUsage()
        ))
    }
}

// 性能指标
fun getPerformanceMetrics() = mapOf(
    "activeConnections" to getActiveConnections(),
    "requestsPerSecond" to getRequestRate(),
    "averageResponseTime" to getAverageResponseTime(),
    "errorRate" to getErrorRate()
)
```

## 总结

第二次迭代的技术实现取得了重大突破：

### 核心技术成就

1. **设计系统建立**: 创建了完整的Glassmorphism设计语言，提供了统一的视觉规范
2. **前后端深度集成**: 实现了完整的业务流程打通，建立了规范的API体系
3. **权限管理完善**: 建立了多层级的权限控制系统，确保了系统安全性
4. **开发体验优化**: 提供了完善的开发工具和调试环境，提升了开发效率

### 技术亮点

- **现代化设计**: Glassmorphism设计理念的成功应用
- **组件化架构**: 高度可复用的组件体系
- **环境配置管理**: 完善的多环境配置系统
- **性能优化**: 前后端全方位的性能优化
- **安全设计**: 多层次的安全防护机制

### 可扩展性

本次迭代建立的技术架构具有良好的可扩展性，为后续功能开发提供了坚实的技术基础。系统已经具备了生产环境部署的基本条件，可以支持大规模的用户访问和业务扩展。
